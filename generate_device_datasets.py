import os
import csv
import glob
import shutil

header = 'frame_len,frame_protocols,ip_len,ip_flags,ip_ttl,ip_proto,ip_src,ip_dst,tcp_srcport,tcp_dstport,tcp_len,tcp_hdr_len,tcp_flags,tcp_window_size_value,tcp_window_size,tcp_window_size_scalefactor,tcp_time_relative,tcp_time_delta,tcp_analysis_bytes_in_flight,tcp_analysis_push_bytes_sent,is_malware,malware_type,device,phase\n'

def write_data(infile, outfile):

    print(f'writing {infile} to {outfile}')

    # Check if the file already exists or not
    # If it does not, write the header
    if os.path.exists(outfile):
        f = open(outfile, 'a')
    else:
        f = open(outfile, 'w')
        f.write(header)
    
    # Open csv
    records = open(infile)
    # Skip header
    records.readline()
    # Write lines of infile to outfile
    for line in records:
        f.write(line)
    # Close the files    
    records.close()
    f.close()
    print('closing files')


# Loop through all the files in current directory
for file in os.listdir():
    # If the file is a csv, contains the word mal, and is not one of the produced csvs...
    if file.endswith('.csv') and file.find('mal') != -1 and file.find('data') == -1:
        # skip the combined csv files
        if file.find('combined') != -1:
            continue
        elif file.find('lock') != -1:
            write_data(file, "mal_lock_data.csv")
        elif file.find('fan') != -1:
            write_data(file, "mal_fan_data.csv")
        elif file.find('light') != -1:
            write_data(file, "mal_light_data.csv")
        elif file.find('switch') != -1:
            write_data(file, "mal_switch_data.csv")
        elif file.find('raspberry1') != -1:
            write_data(file, "mal_rasp1_data.csv")
        else:
            write_data(file, "mal_rasp2_data.csv")
    elif file.endswith('csv') and file.find('leg') != 1 and file.find('data') == -1:
        if file.find('combined') != -1:
            continue
        elif file.find('lock') != -1:
            write_data(file, "leg_lock_data.csv")
        elif file.find('fan') != -1:
            write_data(file, "leg_fan_data.csv")
        elif file.find('light') != -1:
            write_data(file, "leg_light_data.csv")
        elif file.find('switch') != -1:
            write_data(file, "leg_switch_data.csv")
        elif file.find('raspberry1') != -1:
            write_data(file, "leg_rasp1_data.csv")
        else:
            write_data(file, "leg_rasp2_data.csv")
    else:
        continue

pattern = "*_data.csv"
files = glob.glob(pattern)
for f in files:
    print('moving files to device_data')
    shutil.move(f, 'device_data')
