# Code used to convert fine-grained pcap files to csv format
# Change fields in tshark command to select different features

import os
import csv
import shutil

# loop throught malware and normal directories
dirs = ['malware', 'normal']
# create a new directory to store the csv files
os.mkdir('fine_grained_csv') 
# path
path = '/home/fameraag/Desktop/MedBiot/medbiot_original/fine-grained/raw_dataset'

# loop through desired directories
for d in dirs:
    # change to new directory
    os.chdir(f'{path}/{d}')
    # loop through files in directory
    for file in os.listdir():
        # select only the pcap files
        if file.endswith(".pcap"):
            # tshark command to convert pcap to csv
            command = f'tshark -r {file} -T fields -E header=y -E separator=, -E quote=d -E occurrence=f -e frame.len -e frame.protocols -e ip.len -e ip.flags -e ip.ttl -e ip.proto -e ip.src  -e ip.dst -e tcp.srcport -e tcp.dstport -e tcp.len -e tcp.hdr_len -e tcp.flags -e tcp.window_size_value -e tcp.window_size -e tcp.window_size_scalefactor -e tcp.time_relative -e tcp.time_delta -e tcp.analysis.bytes_in_flight -e tcp.analysis.push_bytes_sent > {file[:-5]}.csv'
            # run the tshark command
            os.system(command)
            # move newly created csv to new directory
            shutil.move(f'{file[:-5]}.csv', f'{path}/fine_grained_csv')
